/*<ORACLECOPYRIGHT>
* Copyright (C) 1994-2013 Oracle and/or its affiliates. All rights reserved.
* Oracle and Java are registered trademarks of Oracle and/or its affiliates.
* Other names may be trademarks of their respective owners.
* UNIX is a registered trademark of The Open Group.
*
* This software and related documentation are provided under a license agreement
* containing restrictions on use and disclosure and are protected by intellectual property laws.
* Except as expressly permitted in your license agreement or allowed by law, you may not use, copy,
* reproduce, translate, broadcast, modify, license, transmit, distribute, exhibit, perform, publish,
* or display any part, in any form, or by any means. Reverse engineering, disassembly,
* or decompilation of this software, unless required by law for interoperability, is prohibited.
*
* The information contained herein is subject to change without notice and is not warranted to be error-free.
* If you find any errors, please report them to us in writing.
*
* U.S. GOVERNMENT RIGHTS Programs, software, databases, and related documentation and technical data delivered to U.S.
* Government customers are "commercial computer software" or "commercial technical data" pursuant to the applicable
* Federal Acquisition Regulation and agency-specific supplemental regulations.
* As such, the use, duplication, disclosure, modification, and adaptation shall be subject to the restrictions and
* license terms set forth in the applicable Government contract, and, to the extent applicable by the terms of the
* Government contract, the additional rights set forth in FAR 52.227-19, Commercial Computer Software License
* (December 2007). Oracle America, Inc., 500 Oracle Parkway, Redwood City, CA 94065.
*
* This software or hardware is developed for general use in a variety of information management applications.
* It is not developed or intended for use in any inherently dangerous applications, including applications that
* may create a risk of personal injury. If you use this software or hardware in dangerous applications,
* then you shall be responsible to take all appropriate fail-safe, backup, redundancy,
* and other measures to ensure its safe use. Oracle Corporation and its affiliates disclaim any liability for any
* damages caused by use of this software or hardware in dangerous applications.
*
* This software or hardware and documentation may provide access to or information on content,
* products, and services from third parties. Oracle Corporation and its affiliates are not responsible for and
* expressly disclaim all warranties of any kind with respect to third-party content, products, and services.
* Oracle Corporation and its affiliates will not be responsible for any loss, costs,
* or damages incurred due to your access to or use of third-party content, products, or services.
</ORACLECOPYRIGHT>*/
if(typeof(SiebelApp.WebDB)==="undefined"){SiebelJS.Namespace("SiebelApp.WebDB");SiebelApp.WebDB=(function(){var a=SiebelApp.Offlineconstants;var b;function d(){var e;var h=0;var f;g=function g(){b=JSON.parse(window.localStorage.getItem(a.get("TABLEINFO")));return e};g.prototype=this;e=new g();e.constructor=g;this.IncrementTxnCnt=function(){h++};this.DecrementTxnCnt=function(){h--;if(f&&this.GetTxnCnt()<=0){f();this.ResetPostTxnCallback()}};this.SetPostTxnCallback=function(i){if(this.GetTxnCnt()<=0){i();return}f=i};this.ResetPostTxnCallback=function(){f=undefined};this.GetTxnCnt=function(){return h};return e}var c;c=new d();d.prototype.Initialize=function(g){var i=g.dbName;var j=g.version;var l=g.displayName;var m=g.maxSize;var o=g.tables;var h=g.columns;var k;var e=SiebelApp.WebDB.initDatabase(i,j,l,m);if(!e){return e}if(o){for(var f=0;f<o.length;f++){k=SiebelApp.SqlBuilder.CreateTable(o[f],h[o[f]]);SiebelApp.WebDB.CreateTable(k)}}return e};d.prototype.initDatabase=function(f,h,g,l){var i=true;try{if(!window.openDatabase){alert("Databases are not supported in this browser.");i=false}else{WebDB=openDatabase(f,h,g,l)}}catch(k){if(k===2){SiebelJS.Log("Invalid database version.")}else{if(k.code===18){SiebelJS.Log("In sufficient memory. Error: "+k+".");var j=SiebelApp.S_App.OfflineLocaleObject.GetLocalString("IDS_DOUI_ERR_INSUFFICIENT_MEMORY");alert(j)}else{SiebelJS.Log("Unknown error "+k+".")}}i=false}return i};d.prototype.DeleteTable=function(e){SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(f){f.executeSql(e,[],function(g,h){SiebelApp.WebDB.DecrementTxnCnt()},function(g,h){SiebelApp.WebDB.DecrementTxnCnt();SiebelJS.Log("Oops.  Error was "+h.message+" (Code "+h.code+")");SiebelJS.Log("Oops.  Error was "+h.message+" (Code "+h.code+")");SiebelJS.Log("WebStore.DeleteTable -> DeleteQuery: "+e);return true})})};d.prototype.CreateTable=function(e){SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(f){f.executeSql(e,[],function(g,h){SiebelApp.WebDB.DecrementTxnCnt()},function(g,h){SiebelApp.WebDB.DecrementTxnCnt();if(h.code===1){SiebelJS.Log("DB Table already exists")}else{SiebelJS.Log("Oops.  Error was "+h.message+" (Code "+h.code+")");SiebelJS.Log("Oops.  Error was "+h.message+" (Code "+h.code+")");SiebelJS.Log("WebStore.CreateTable -> CreateQuery: "+e)}return true})})};d.prototype.InsertRecordSet=function(s,f,o,q){var t=500;var r=[];var e=f.length;var h="INSERT INTO "+s+" (";for(var n=0;n<e;n++){h+=" "+f[n];if(n<e-1){h+=", "}}h+=")";var m=o.length;for(var g=0;g<m&&g<t;g++){h+=" SELECT ";for(var l=0;l<e;l++){var p=(o[g])[l];p=p.replace(/\"/g,'""');h+=' "'+p+'"';if(l<e-1){h+=", "}}h+=" UNION ALL "}h=SiebelApp.OfflineUtils.RTrim(h," UNION ALL ");SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(i){i.executeSql(h,[],function(j,k){if(m>t){r=o.slice(t);SiebelApp.WebDB.InsertRecordSet(s,f,r,q)}else{if(q){q()}}SiebelApp.WebDB.DecrementTxnCnt()},function(j,k){SiebelJS.Log("Oops.  Error was "+k.message+" (Code "+k.code+")");SiebelJS.Log("Oops.  Error was "+k.message+" (Code "+k.code+")");SiebelJS.Log("WebStore.InsertRecordSet -> InsertQuery: "+h);if(m>t){r=o.slice(t);SiebelApp.WebDB.InsertRecordSet(s,f,r,q)}SiebelApp.WebDB.DecrementTxnCnt();return true})})};d.prototype.SelectAll=function(i,g,e){var h;var f=[];SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(j){j.executeSql(i.selectQuery,[],function(k,l){for(var m=0;m<l.rows.length;m++){h=l.rows.item(m);f.push(h)}e(f);SiebelApp.WebDB.DecrementTxnCnt()},function(k,l){SiebelApp.WebDB.DecrementTxnCnt();if(l.code===1){SiebelJS.Log("DB Table already exists")}else{SiebelJS.Log("Oops.  Error was "+l.message+" (Code "+l.code+")");SiebelJS.Log("Oops.  Error was "+l.message+" (Code "+l.code+")");SiebelJS.Log("WebStore.SelectAll -> SelectQuery: "+i)}return true})})};d.prototype.SelectAllUpSync=function(h,e){var g;var f=[];SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(i){i.executeSql(h,[],function(j,k){for(var l=0;l<k.rows.length;l++){g=k.rows.item(l);f.push(g)}e(f);SiebelApp.WebDB.DecrementTxnCnt()},function(j,k){SiebelApp.WebDB.DecrementTxnCnt();if(k.code===1){SiebelJS.Log("DB Table already exists")}else{SiebelJS.Log("Oops.  Error was "+k.message+" (Code "+k.code+")");SiebelJS.Log("Oops.  Error was "+k.message+" (Code "+k.code+")");SiebelJS.Log("WebStore.SelectAll -> SelectQuery: "+h)}return true})})};d.prototype.SelectAll=function(i,f){var h=new $.Deferred();var g;var e=[];SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(j){j.executeSql(i.selectQuery,[],function(k,l){for(var m=0;m<l.rows.length;m++){g=l.rows.item(m);e.push(g)}h.resolve(e);SiebelApp.WebDB.DecrementTxnCnt()},function(k,l){SiebelApp.WebDB.DecrementTxnCnt();if(l.code===1){SiebelJS.Log("DB Table already exists")}else{h.reject(null);SiebelJS.Log("Oops.  Error was "+l.message+" (Code "+l.code+")");SiebelJS.Log("Oops.  Error was "+l.message+" (Code "+l.code+")");SiebelJS.Log("WebStore.SelectAll -> SelectQuery: "+i)}return true})});return h.promise()};d.prototype.Execute=function(f,e,h){var g=new $.Deferred();SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(i){i.executeSql(f,e,function(j,k){SiebelApp.WebDB.DecrementTxnCnt();var n;if(k.rows){var m=k.rows.length;if(h===true){n=[];for(var l=0;l<m;l++){n.push(k.rows.item(l))}}else{if(m>0){n=k.rows.item(0)}}}g.resolve(n)},function(j,k){SiebelApp.WebDB.DecrementTxnCnt();SiebelJS.Log("Oops.  Error was "+k.message+" (Code "+k.code+")");SiebelJS.Log("WebStore.Execute ->: "+f);g.reject(k);return true})});return g.promise()};d.prototype.DoesTableExist=function(e){if(!b){b=window.localStorage.getItem(a.get("TABLEINFO"))}if(b){return(b.hasOwnProperty(e))}else{return false}};d.prototype.UpdateRecord=function(f,g){var e=new $.Deferred();SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(h){SiebelApp.WebDB.DecrementTxnCnt();h.executeSql(f,[g],function(i,j){e.resolve(j.rowsAffected)},function(i,j){SiebelApp.WebDB.DecrementTxnCnt();if(j.code===1){SiebelJS.Log("Unable to Update the record.")}else{SiebelJS.Log("Oops.  Error was "+j.message+" (Code "+j.code+")");SiebelJS.Log("Oops.  Error was "+j.message+" (Code "+j.code+")");SiebelJS.Log("WebStore.UpdateRecord -> UpdateQuery: "+f)}e.reject(j);return true})});return e.promise()};d.prototype.DoesFieldExist=function(e,h){var f=false;h=h.toUpperCase();if(!b){b=JSON.parse(window.localStorage.getItem(a.get("TABLEINFO")))}if(b){var g=b[e];if(g){f=(g.indexOf(h)!==-1)}}return f};return c}())};