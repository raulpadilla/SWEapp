if(typeof(SiebelApp.S_App.HistoryMgr)==="undefined"){SiebelJS.Namespace("SiebelApp.S_App.HistoryMgr");SiebelApp.S_App.HistoryMgr=(function(){var utils=SiebelApp.Utils;var consts=SiebelApp.Constants;function HistoryMgr(){var m_caption="";var m_url="";var m_action="";var m_pendingUpdate=false;var m_pendingReplace=false;var m_excludeFromHistory=false;var m_viewExclude=false;var m_firstRun=true;var m_refreshUrl="";var m_inHistoryManipulation=0;var m_inHistoryNavigation=0;this.GetCaption=function(){return m_caption};this.SetCaption=function(caption){m_caption=caption};this.GetURL=function(){return m_url};this.SetURL=function(url){m_url=url};this.GetAction=function(){return m_action};this.SetAction=function(action){m_action=action};this.GetPendingUpdate=function(){return m_pendingUpdate};this.SetPendingUpdate=function(pendingUpdate){m_pendingUpdate=pendingUpdate};this.GetPendingReplace=function(){return(m_pendingReplace>0?true:false)};this.SetPendingReplace=function(pendingReplace){if(pendingReplace){m_pendingReplace+=1}else{if(m_pendingReplace>0){m_pendingReplace-=1}}};this.IsInHistoryManipulation=function(){return(m_inHistoryManipulation>0?true:false)};this.SetInHistoryManipulation=function(inHistoryManipulation){if(inHistoryManipulation){m_inHistoryManipulation+=1}else{if(m_inHistoryManipulation>0){m_inHistoryManipulation-=1}}};this.IsInHistoryNavigation=function(){return(m_inHistoryNavigation>0?true:false)};this.SetInHistoryNavigation=function(inHistoryNavigation){if(inHistoryNavigation){m_inHistoryNavigation+=1}else{if(m_inHistoryNavigation>0){m_inHistoryNavigation-=1}}};this.GetExcludeFromHistory=function(){return m_excludeFromHistory};this.SetExcludeFromHistory=function(excludeFromHistory){m_excludeFromHistory=excludeFromHistory};this.GetViewExclude=function(){return m_viewExclude};this.SetViewExclude=function(viewExclude){m_viewExclude=viewExclude};this.IsFirstRun=function(){return m_firstRun};this.SetFirstRun=function(firstRun){m_firstRun=firstRun};this.GetRefreshUrl=function(){return m_refreshUrl};this.SetRefreshUrl=function(refreshUrl){m_refreshUrl=refreshUrl};BindBrowserEvents.call(this)}function BindBrowserEvents(){if(!utils.IsEmpty(History)){var that=this;History.Adapter.bind(window,"statechange",function(){if(!that.IsInHistoryManipulation()){var State=History.getState();ProcessBrowserHistoryCall.call(that,State)}else{that.SetInHistoryManipulation(false)}});$(window).bind("unload",{ctx:this},function(event){ProcessBrowserRefresh.call(event.data.ctx)});window.onbeforeunload=function(){window.unload=null;ProcessBrowserRefresh.call(that)}}}HistoryMgr.prototype.ProcessObjectInfo=function(psInfo){if(psInfo.GetType()!==consts.get("SWE_HIST_OUI_UPDATE_INFO")){return false}if(this.IsFirstRun()){this.SetRefreshUrl(top.location.href);this.SetFirstRun(false);this.SetPendingReplace(true)}var action=HtmlDecode(psInfo.GetProperty(consts.get("SWE_HIST_NAV_ACT")));var url=utils.DecodeURL(HtmlDecode(psInfo.GetProperty(consts.get("SWE_HIST_NAV_URL"))));var caption=HtmlDecode(psInfo.GetProperty(consts.get("SWE_HIST_NAV_CAP")));if(utils.IsEmpty(action)||utils.IsEmpty(url)||utils.IsEmpty(caption)){return false}if(this.IsInHistoryNavigation()){this.SetInHistoryNavigation(false);this.SetCaption(caption);this.SetURL(url);this.SetAction(action);return false}if(this.GetExcludeFromHistory()){this.SetPendingReplace(true);this.SetExcludeFromHistory(false)}if(this.GetAction()&&this.GetAction().substring(0,this.GetAction().indexOf(","))===action.substring(0,action.indexOf(","))){if(this.GetURL()!==url){this.SetPendingReplace(true)}else{if(psInfo.GetProperty(consts.get("SWE_HIST_REPLACE"))){this.SetViewExclude(true)}else{return false}}}if(this.GetViewExclude()||psInfo.GetProperty(consts.get("SWE_HIST_ISPAGE"))||action.indexOf(consts.get("SWE_HIST_GOTOURL"))>-1){this.SetViewExclude(false);var existingHistoryState=History.getState();caption=existingHistoryState.title+" ";url=existingHistoryState.url;action=existingHistoryState.data[consts.get("SWE_HIST_NAV_ACT")];this.SetExcludeFromHistory(true)}this.SetCaption(caption);this.SetURL(url);this.SetAction(action);this.SetPendingUpdate(true);return true};function UpdateHistoryState(){var actionObject={};actionObject[consts.get("SWE_HIST_NAV_ACT")]=this.GetAction();actionObject[consts.get("SWE_HIST_EXLUDE")]=this.GetExcludeFromHistory();var caption=this.GetCaption();var replaceUrl="";if(utils.IsTrue(SiebelApp.S_App.UseCookie())){replaceUrl=this.GetURL().substring(this.GetURL().indexOf("?"))}else{replaceUrl=this.GetRefreshUrl().substring(this.GetRefreshUrl().indexOf("?"))}History.pushState(actionObject,caption,replaceUrl);SiebelApp.S_App.OfflineCallMethod("ReplaceShortURL",actionObject,caption);return true}function ReplaceHistoryState(){if(utils.IsEmpty(window.history.replaceState)){this.SetInHistoryManipulation(false);return true}var actionObject={};actionObject[consts.get("SWE_HIST_NAV_ACT")]=this.GetAction();actionObject[consts.get("SWE_HIST_EXCLUDE")]=this.GetExcludeFromHistory();var caption=this.GetCaption();var replaceUrl="";if(utils.IsTrue(SiebelApp.S_App.UseCookie())){replaceUrl=this.GetURL().substring(this.GetURL().indexOf("?"))}else{replaceUrl=this.GetRefreshUrl().substring(this.GetRefreshUrl().indexOf("?"))}var currentState=History.getState();if(currentState.title===caption&&currentState.url===this.GetURL()){this.SetInHistoryManipulation(false);return true}History.replaceState(actionObject,caption,replaceUrl);SiebelApp.S_App.OfflineCallMethod("ReplaceShortURL",actionObject,caption);return true}HistoryMgr.prototype.ManipulateHistoryState=function(){if(!this.GetPendingUpdate()){return false}var action=this.GetAction();var caption=this.GetCaption();var url=this.GetURL();if(utils.IsEmpty(action)||utils.IsEmpty(caption)||utils.IsEmpty(url)){this.SetPendingReplace(false);this.SetPendingUpdate(false);return false}if(utils.IsEmpty(History)){this.SetPendingReplace(false);this.SetPendingUpdate(false);return false}this.SetInHistoryManipulation(true);if(this.GetPendingReplace()){ReplaceHistoryState.call(this);this.SetPendingReplace(false)}else{UpdateHistoryState.call(this)}this.SetPendingUpdate(false);return true};function ProcessBrowserHistoryCall(state){var bRet=true;if(bRet&&!utils.IsEmpty(state)){var actionObject=state.data;if(!utils.IsEmpty(actionObject)){var action=actionObject[consts.get("SWE_HIST_NAV_ACT")];this.SetExcludeFromHistory(actionObject[consts.get("SWE_HIST_EXLUDE")]);if(!utils.IsEmpty(action)){action=action.substring(0,action.lastIndexOf(","))+")";this.SetInHistoryNavigation(true);SiebelApp.S_App.SetDiscardUserState(true);bRet=eval(action);SiebelApp.S_App.SetDiscardUserState(false)}}}if(bRet===false){this.SetInHistoryNavigation(false);this.SetPendingUpdate(true);this.ManipulateHistoryState()}}function ProcessBrowserRefresh(){var browserUrl=top.location.toString();var suid=consts.get("SWE_HIST_PARAM_SUID");if(browserUrl.indexOf(suid)>-1){browserUrl=browserUrl.substring(0,browserUrl.indexOf(suid))+((browserUrl.indexOf("&",browserUrl.indexOf(suid)+1)<0)?"":browserUrl.substring(browserUrl.indexOf("&",browserUrl.indexOf(suid)+1)))
}if(this.GetURL()===browserUrl){var expDate=new Date();expDate.setTime(expDate.getTime()+2000);var name="_srn";var srn=SiebelApp.S_App.GetSRN();$.cookie(name,srn,{expires:expDate});setTimeout(function(){$.cookie(name,null)},10)}}return HistoryMgr}())};