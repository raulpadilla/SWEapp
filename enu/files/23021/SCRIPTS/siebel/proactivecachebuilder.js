if(typeof(SiebelApp.ProactiveCacheBuilder)==="undefined"){SiebelJS.Namespace("SiebelApp.ProactiveCacheBuilder");SiebelApp.ProactiveCacheBuilder=(function(){var e=new f();var b=SiebelApp.OfflineCacheConfig;var a=SiebelApp.Offlineconstants;var c=SiebelJS.Dependency("SiebelApp.Utils");var g={};function f(){var h;i=function i(){return h};i.prototype=this;h=new i();h.constructor=i;return h}f.prototype.ParseAndCacheData=function(J,r){var o=CCFMiscUtil_CreatePropSet();o.DecodeFromString(J);var D;var t=o.GetChildCount();if(!t){return}SiebelJS.Log("Caching Data...."+SiebelApp.OfflineUtils.GetTS());SiebelApp.S_App.uiStatus.Busy({mask:true,timeOut:false});SiebelApp.BrowserCacheMgr.DBInitialize(b.get("PRO_DATASTORE_DB"));for(var E=0;E<t;E++){var F=o.GetChild(E);var s=F.GetType();var v={};var l=[];var j=F.GetChildCount();for(var z=0;z<j;z++){var B=F.GetChild(z);v[B.GetType()]=B}if(v.Schema!==undefined){var y=v.Schema.GetProperty("Schema");if(y!==undefined){y=SiebelApp.OfflineUtils.RemoveNonAlphaChars(y);s=SiebelApp.OfflineUtils.RemoveNonAlphaChars(s);l=y.split("|");D=l.length;if(y.indexOf("||")!==-1){SiebelJS.Log("Bad Schema for "+s+" :"+y);for(var u=0;u<D;u++){if(c.IsEmpty(l[u])){l.splice(u,1);D=l.length}}}if(r){l.splice(r,(D-r))}if((s!=="ViewTagInfo")){l.push("OF_New");D=D+1}SiebelApp.BrowserCacheMgr.CreateTable(s,l);g[s]=l;SiebelApp.OfflineUtils.Log("Creating Table...")}}if(v.Data!==undefined){if(v.Data.GetChildCount()){var x=v.Data.GetChildCount();var h=(x<a.get("MAX_RECORDS"))?x:a.get("MAX_RECORDS");var q=[];SiebelApp.OfflineUtils.Log("Table: "+s+", Columns: "+l.length+", Num of Records: "+x);for(var C=0;C<h;C++){var G=v.Data.GetChild(C);if(!G){continue}var p=G.GetProperty("Record");if(!p){continue}var H=p.split("|");var w=H.length;if(r){H.splice(r,(w-r))}for(var A=0;A<w;A++){if(H[A]===undefined||H[A]===""){H[A]="null"}}if(w!==D){SiebelApp.OfflineUtils.Log("There is a mismatch in the number of columns ("+D+") and values ("+w+") for BC: "+s);if(w<D){var I=D-w;for(A=0;A<I;A++){H.push("null")}}}q.push(H);if(s==="ViewTagInfo"||s==="PickListInfo"||s==="PickListGeneric"){SiebelApp.BrowserLocalStorage.InsertRecord(s,l,H)}}SiebelApp.BrowserCacheMgr.InsertRecordSet(s,l,q)}}}SiebelApp.BrowserCacheMgr.GetBrowserStorage().SetPostTxnCallback(SiebelApp.ProactiveCacheBuilder.PostDataCaching)};f.prototype.PostDataCaching=function(){SiebelApp.BrowserCacheMgr.SetViewTagInfo();SiebelApp.S_App.uiStatus.Free();alert("Offline Package Download is done.");window.localStorage.setItem(a.get("TABLEINFO"),JSON.stringify(g));SiebelJS.Log("Caching Data...is Done. "+SiebelApp.OfflineUtils.GetTS());SiebelApp.S_App.CustomToolbar.Update();window.location.reload(false)};f.prototype.ParseAndCacheMetadata=function(q){SiebelApp.OfflineUtils.Log("Parsing and Caching Metadata...."+SiebelApp.OfflineUtils.GetTS());var p=q.GetChildCount();SiebelApp.OfflineUtils.Log("ProactiveCacheBuilder.ParseAndCacheMetadata -> DBInitialize");var A=SiebelApp.BrowserCacheMgr.DBInitialize(b.get("PRO_METADATASTORE_DB"));var s;var z;var n;var C;var t;var o=[];var r=b.get("PRO_METADATASTORE_DB_TBL_COLS");SiebelApp.BrowserCacheMgr.CacheSyncNodeId(q.GetProperty("SyncNodeId"));SiebelApp.BrowserCacheMgr.CacheSRFId(q.GetProperty("srfid"));var k=q.GetProperty("sc");SiebelApp.BrowserCacheMgr.CacheSCMap(k);for(var y=0;y<p;y++){var v=[];s=q.GetChild(y);z=s.GetType();C=s.GetProperty(a.get("VIEW_NAME"));switch(z){case a.get("FLD_PICK_APLT_DET"):n=s.GetProperty(a.get("PICK_APLT_DET"));SiebelApp.ProactiveCacheBuilder.ParseAndCachePickAppletInfo(z,n);continue;case a.get("FLD_PICK_MAP"):n=s.GetProperty(a.get("PICK_MAP_INFO"));SiebelApp.ProactiveCacheBuilder.ParseAndCachePickAppletInfo(z,n);continue;case a.get("VIEW_INFO"):if(C!==undefined){o.push(C)}break}var m=Object.keys(s.propArray);var u=m.length;for(var w=0;w<u;w++){if(m[w]!==a.get("VIEW_NAME")){v.push(m[w])}}var B=v.length;for(var x=0;x<B;x++){var h=s.propArray[v[x]];if(h){SiebelApp.BrowserCacheMgr.InsertRecord(b.get("PRO_METADATASTORE_DB_TBL"),[r.ObjName,r.SweCmd,r.Response,r.Type],[C,v[x],h,z])}}}SiebelApp.BrowserCacheMgr.CacheViewList(o);SiebelApp.OfflineAppMgr.SetCmdMap();SiebelApp.BrowserCacheMgr.GetInitPkg(function(D){for(var j=0;j<D.length;j++){var E=D[j];var l;var i;if((E.Request.search("GetCachedFrame")===-1)&&(E.Request.search("GotoPostedAction")===-1)&&(E.Request.search("scriptfiles.txt")===-1)){if((E.Request.search("Home")!==-1)&&(E.Request.search("Page")!==-1)&&(E.Request.search("View")!==-1)){i=E.Request.split("&");for(y=0;y<i.length;y++){if(i[y].search("SWEView")!==-1){t=i[y].split("=");if(E.Request.search("GotoView")!==-1){l=SiebelApp.RequestProcessor.GetCmdTag(a.get("GOTOVIEW"))}else{l=SiebelApp.RequestProcessor.GetCmdTag(a.get("GETVIEWLAYOUT"));t[1]=t[1].replace(/%20/g," ")}SiebelApp.BrowserCacheMgr.InsertInitPkgRecords(t[1],l,E.Response,a.get("VIEW_INFO"));break}}}else{break}}else{if((E.Request.search("scriptfiles.txt")!==-1)){l=a.get("TEXT");SiebelApp.BrowserCacheMgr.InsertInitPkgRecords("scriptfiles",l,E.Response,a.get("DEFAULT_VIEW_INFO"));continue}i=E.Request.split("&");for(y=0;y<i.length;y++){if(i[y].search("SWEFrame")!==-1){t=i[y].split("=");if(E.Request.search("GetCachedFrame")!==-1){l=SiebelApp.RequestProcessor.GetCmdTag(a.get("GETCACHEDFRAME"))}else{l=SiebelApp.RequestProcessor.GetCmdTag(a.get("GOTOPOSTEDACTION"))}SiebelApp.BrowserCacheMgr.InsertInitPkgRecords(t[1],l,E.Response,a.get("DEFAULT_VIEW_INFO"));break}}}}});SiebelJS.Log("Getting Offline Metadata....is Done. "+SiebelApp.OfflineUtils.GetTS());SiebelApp.S_App.uiStatus.Free()};f.prototype.ParseAndCachePickAppletInfo=function(o,l){var p;var k;if(c.IsEmpty(l)||c.IsEmpty(o)){SiebelJS.Log("ProactiveCacheBuilder.CachePickAppletInfo: Pick Applet Details is empty.");return}switch(o){case a.get("FLD_PICK_APLT_DET"):p=b.get("PRO_DB_PICKAPPLET_INFO_TBL_COLS");k=l.split("|");if(k&&k.length===3){SiebelApp.BrowserCacheMgr.InsertRecord(b.get("PRO_DB_PICKAPPLET_INFO_TBL"),[p.FldInfo,p.PickApplet],[k[0]+"|"+k[1],k[2]])}else{SiebelJS.Log("ProactiveCacheBuilder.CachePickAppletInfo: "+l+" Could not cache Pick Applet Info.")}break;case a.get("FLD_PICK_MAP"):p=b.get("PRO_DB_PICKFLD_MAP_TBL_COLS");k=l.split("|");if(k&&k.length===3){var s="null";var r=k[2];var j=r.split(",");var m=j.length;r="";for(var i=0;i<m;i++){if(!j[i]){continue}var n=j[i].split(":");var q=n.length;if(q>=2){if(n[0]&&n[1]){var h=n[0]+":"+n[1];r+=h+",";if(q===3&&n[2]==="1"){s=h}}}else{SiebelJS.Log("ProactiveCacheBuilder.ParseAndCachePickAppletInfo: Invalid pick map "+j[i])}}r=SiebelApp.OfflineUtils.RTrim(r,",");SiebelApp.BrowserCacheMgr.InsertRecord(b.get("PRO_DB_PICKFLD_MAP_TBL"),[p.BCName,p.FldName,p.PMap,p.PConstraint],[k[0],k[1],r,s])}else{SiebelJS.Log("ProactiveCacheBuilder.CachePickAppletInfo: "+l+" Could not cache Field Pick Map Info.")}break}};f.prototype.ProcessGoOnline=function(){SiebelApp.S_App.uiStatus.Busy({mask:true,timeOut:false});var m=[];var i=[];SiebelApp.OfflineAppSettings.SetMode((!SiebelApp.OfflineAppSettings.GetMode()));SiebelApp.OfflineAppSettings.SetSyncStatus(false);
SiebelApp.S_App.CustomToolbar.Update();var o=SiebelApp.OfflineUtils.GetOfflineCacheConfig(b.get("PRO_METADATASTORE_DB"));var j=o.tables;if(j){var l=j.length;for(var h=0;h<l;h++){SiebelApp.BrowserCacheMgr.DeleteTable(j[h])}}var k=JSON.parse(window.localStorage.getItem(a.get("TABLEINFO")));var q;for(q in k){if(i.indexOf(q)===-1){SiebelApp.BrowserCacheMgr.DeleteTable(q)}}SiebelApp.BrowserCacheMgr.DeleteTable(b.get("REACTIVE_CACHE_TBL"));SiebelApp.BrowserCacheMgr.DeleteTable(b.get("PRO_SYNCQUEUE_DB_TBL"));var p;for(p in localStorage){if(m.indexOf(p)===-1){localStorage.removeItem(p)}}SiebelApp.BrowserCacheMgr.GetBrowserStorage().SetPostTxnCallback(SiebelApp.OfflineAppSettings.ReloadApp)};var d=window.applicationCache;d.ondownloading=function(h){if(d.status!==1){SiebelApp.S_App.uiStatus.Busy({mask:true,timeOut:false});SiebelJS.Log("Application Cache Downloading...."+SiebelApp.OfflineUtils.GetTS())}};d.oncached=function(h){if(d.status===1){SiebelApp.S_App.uiStatus.Free();SiebelJS.Log("Application Cache Downloaded...."+SiebelApp.OfflineUtils.GetTS())}History.back()};d.onprogress=function(h){if(SiebelApp.S_App.uiStatus.m_gbusy===0){if(d.status!==1){if(!SiebelApp.S_App.uiStatus.IsBusy()){SiebelApp.S_App.uiStatus.Busy({mask:true,timeOut:false})}}}};d.onerror=function(h){SiebelApp.S_App.uiStatus.Free();SiebelJS.Log("Error in downlaoding Application Cache")};return e}())};