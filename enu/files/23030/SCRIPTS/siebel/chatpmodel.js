/*<ORACLECOPYRIGHT>
* Copyright (C) 1994-2013 Oracle and/or its affiliates. All rights reserved.
* Oracle and Java are registered trademarks of Oracle and/or its affiliates.
* Other names may be trademarks of their respective owners.
* UNIX is a registered trademark of The Open Group.
*
* This software and related documentation are provided under a license agreement
* containing restrictions on use and disclosure and are protected by intellectual property laws.
* Except as expressly permitted in your license agreement or allowed by law, you may not use, copy,
* reproduce, translate, broadcast, modify, license, transmit, distribute, exhibit, perform, publish,
* or display any part, in any form, or by any means. Reverse engineering, disassembly,
* or decompilation of this software, unless required by law for interoperability, is prohibited.
*
* The information contained herein is subject to change without notice and is not warranted to be error-free.
* If you find any errors, please report them to us in writing.
*
* U.S. GOVERNMENT RIGHTS Programs, software, databases, and related documentation and technical data delivered to U.S.
* Government customers are "commercial computer software" or "commercial technical data" pursuant to the applicable
* Federal Acquisition Regulation and agency-specific supplemental regulations.
* As such, the use, duplication, disclosure, modification, and adaptation shall be subject to the restrictions and
* license terms set forth in the applicable Government contract, and, to the extent applicable by the terms of the
* Government contract, the additional rights set forth in FAR 52.227-19, Commercial Computer Software License
* (December 2007). Oracle America, Inc., 500 Oracle Parkway, Redwood City, CA 94065.
*
* This software or hardware is developed for general use in a variety of information management applications.
* It is not developed or intended for use in any inherently dangerous applications, including applications that
* may create a risk of personal injury. If you use this software or hardware in dangerous applications,
* then you shall be responsible to take all appropriate fail-safe, backup, redundancy,
* and other measures to ensure its safe use. Oracle Corporation and its affiliates disclaim any liability for any
* damages caused by use of this software or hardware in dangerous applications.
*
* This software or hardware and documentation may provide access to or information on content,
* products, and services from third parties. Oracle Corporation and its affiliates are not responsible for and
* expressly disclaim all warranties of any kind with respect to third-party content, products, and services.
* Oracle Corporation and its affiliates will not be responsible for any loss, costs,
* or damages incurred due to your access to or use of third-party content, products, or services.
</ORACLECOPYRIGHT>*/
if(typeof(SiebelAppFacade.ChatPresentationModel)==="undefined"){SiebelJS.Namespace("SiebelAppFacade.ChatPresentationModel");SiebelAppFacade.ChatPresentationModel=(function(){var r=SiebelJS.Dependency("SiebelApp.Constants");var z=SiebelJS.Dependency("SiebelApp.Utils");var d=3000;function e(){SiebelAppFacade.ChatPresentationModel.superclass.constructor.call(this,{GetName:function(){return"ChatObject"}})}SiebelJS.Extend(e,SiebelAppFacade.PresentationModel);e.prototype.Init=function(){this.AddProperty("ChatSysPref",{bEnableBlinkTab:false,nCustomerTypeDisplayTime:d,nAgentTypeDetectInterval:d});this.AddProperty("ChatTabMap",{});this.AddProperty("CurrentChat",null);this.AddProperty("CurrentTabOnHold",null);this.AddProperty("NewChatMessage",null);this.AddProperty("ShowTypingMsg",null);this.AddProperty("ChatIdRemoved",null);this.AddProperty("ChatUpdated",null);this.AddProperty("ChatIdHold",null);this.AddProperty("ChatResumed",null);this.AddProperty("ChatClearLog",null);this.AddProperty("TextInput4Set",null);this.AddProperty("UrlInput4Set",null);this.AddProperty("ReadLastMessage",null);this.AddProperty("SetFocus",null);this.AddMethod("InvokeServiceMethod",function(G,H,I){var F=SiebelApp.S_App.GetService(r.get("NAME_CHATUISVC"));if(F){p(3,"Open UI - Chat: Invoke Chat UI Business Service Method: "+G);if(!H){H=CCFMiscUtil_CreatePropSet()}H.SetPropertyStr(r.get("CHATUISVC_TAG_METHOD"),G);I=F.InvokeMethod(G,H);if(I){var K=I.GetChildByType(r.get("CHATCC_PROPSET_TYPE_RESULT"));if(K){var J=K.GetProperty(r.get("CHATUISVC_TAG_METHOD"));if(J){C.call(this,J,K)}}}}else{p(1,"Open UI - Chat: Chat UI Business Service Not Found!")}});this.AddMethod("GetCurrChatId",function(){var F=this.Get("CurrentChat");if(F){return F.Id}else{return""}});this.AddMethod("AgentTyping",function(F){var G=this.Get("ChatTabMap")[F];if(G){if((new Date().getTime()-G.agentTypingSentTime)>=this.Get("ChatSysPref").nAgentTypeDetectInterval){G.agentTypingSentTime=new Date().getTime();var H=CCFMiscUtil_CreatePropSet();H.SetProperty("InteractionId",F);H.SetPropertyStr("SWEBS","1");this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_SENDAGENTTYPINGMSG"),H)}}});this.AddMethod("SendMessage",function(F){if(F&&F.chatId&&F.text){var G=CCFMiscUtil_CreatePropSet();G.SetProperty("InteractionId",F.chatId);G.SetProperty("Text",F.text);this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_SENDMESSAGE"),G)}});this.AddMethod("ImplicitSave",function(){return n()});this.AddMethod("SwitchChat",function(G,F){E.call(this,G,F)});this.AddMethod("LoadChatData",function(){f.call(this)});this.AddMethod("HoldTab",function(F){A.call(this,F)});this.AddMethod("GetTextInputValue",function(){u.call(this)});this.AddMethod("GetUrlInputValue",function(){y.call(this)});this.AddMethod("LogMsg",function(G,F){a.call(this,G,F)});this.AddMethod("CloseChatPane",function(){l.call(this)});this.AddMethod("SetFocus",function(){this.SetProperty("SetFocus",true)});this.AttachEventHandler(r.get("CHAT_PANE_CLOSE"),function(){l.call(this);SiebelApp.S_App.UnregisterExtObject("ChatPane")})};function k(){this.SetProperty("ChatSysPref",{bEnableBlinkTab:false,nCustomerTypeDisplayTime:d,nAgentTypeDetectInterval:d});this.SetProperty("ChatTabMap",{});this.SetProperty("CurrentChat",null);this.SetProperty("CurrentTabOnHold",null);this.SetProperty("NewChatMessage",null);this.SetProperty("ShowTypingMsg",null);this.SetProperty("ChatIdRemoved",null);this.SetProperty("ChatUpdated",null);this.SetProperty("ChatIdHold",null);this.SetProperty("ChatResumed",null);this.SetProperty("ChatClearLog",null);this.SetProperty("TextInput4Set",null);this.SetProperty("UrlInput4Set",null);this.SetProperty("SetFocus",null)}e.prototype.Setup=function(F){F.SetProperty("SWE_OUI_RENDERER","ChatPhyRenderer");SiebelAppFacade.ChatPresentationModel.superclass.Setup.call(this,F);q.call(this,F)};e.prototype.HandleNotify=function(F){this.AddProperty("LocaleInfo",{});q.call(this,F)};e.prototype.Notify=function(G){var F=this;G.each(function(){var H=CCFMiscUtil_CreatePropSet();H.DecodeFromString($(this).text());var I=H.GetProperty(r.get("CHATUISVC_TAG_EVENT"));C.call(F,I,H)})};function C(L,N){if(!N||N.IsEmpty()){return}switch(L){case r.get("CHATUISVC_METHOD_INITIALIZEAX"):var G=N.GetPropertyAsStr(r.get("CHATUISVC_TAG_ENABLE_BLINKTAB"));var O=N.GetPropertyAsStr(r.get("CHATUISVC_TAG_TYPEDISTIME"));var H=N.GetPropertyAsStr(r.get("CHATUISVC_TAG_TYPEDECINTERVAL"));var M=this.Get("ChatSysPref");if(G&&G===r.get("CHATUISVC_VALUE_YES")){M.bEnableBlinkTab=true}if(O){var J=parseInt(O,10);if(J>0){M.nCustomerTypeDisplayTime=J*1000}}if(H){var J=parseInt(H,10);if(J>0){M.nAgentTypeDetectInterval=J*1000}}break;case r.get("CHATUISVC_METHOD_UPDATECHATDATA"):m.call(this,N);break;case r.get("CHATUISVC_METHOD_GETFIELDDATA"):j.call(this,N);break;case r.get("CHATUISVC_METHOD_GETSMARTSHARETEXT"):break;case r.get("CHATUISVC_EVENT_ENDCHAT"):case r.get("CHATUISVC_EVENT_WRAPUPCHAT"):g.call(this,N);var K=N.GetPropertyAsStr(r.get("CHATUISVC_TAG_EVENTCHATID"));if(K===this.ExecuteMethod("GetCurrChatId")){}break;case r.get("CHATUISVC_EVENT_NEWMESSAGEINACTIVE"):case r.get("CHATUISVC_EVENT_UPDATECHATDISPLAYNAME"):case r.get("CHATUISVC_EVENT_ACCEPTCHATHOLD"):g.call(this,N);break;case r.get("CHATUISVC_EVENT_HOLDCHAT"):x.call(this,N);break;case r.get("CHATUISVC_EVENT_ACCEPTCHAT"):case r.get("CHATUISVC_EVENT_RESUMECHAT"):s.call(this,L,N);break;case r.get("CHATUISVC_EVENT_NEWMESSAGE"):B.call(this,N);break;case r.get("CHATUISVC_EVENT_UPDATEDATAFIELD"):var I=N.GetPropertyAsStr(r.get("CHATUISVC_TAG_CURRCHATID"));if(I!==this.ExecuteMethod("GetCurrChatId")){p(1,"Current chat id does not match!")}var F=N.Clone();this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_GETFIELDDATA"),F);break;case r.get("CHATUISVC_METHOD_REFRESHCHATPANEDASHBOARD"):break;case r.get("CHATUISVC_EVENT_SHOWTYPINGMSG"):v.call(this,N);break;default:break}}function j(G){var I=G.GetPropertyAsStr(r.get("CHATUISVC_TAG_DATA_FIELD"));var F=G.GetPropertyAsStr(r.get("CHATUISVC_TAG_APPEND"));switch(I){case r.get("CHATUISVC_TAG_TRANSCRIPT"):var H=G.GetProperty(r.get("CHATUISVC_TAG_TRANSCRIPT"));h.call(this,H);break;case r.get("CHATCC_METADATA_CTRLNAME_TEXT"):break;case r.get("CHATCC_METADATA_CTRLNAME_URL"):break;case r.get("CHATCC_METADATA_CTRLNAME_KB"):break;default:break}}function v(F){var G=F.GetPropertyAsStr(r.get("CHATUISVC_TAG_CURRCHATID"));var H=this.Get("ChatTabMap")[G];if(H){this.SetProperty("ShowTypingMsg",H)}}function s(G,F){var I=this.Get("CurrentChat");var K="";if(I&&w(I)){K=I.Id;A.call(this,K)}var H=F.GetPropertyAsStr(r.get("CHATUISVC_TAG_CURRCHATID"));var J=F.Clone();J.SetPropertyStr(r.get("CHATUISVC_TAG_EVENTCHATID"),H);if(G===r.get("CHATUISVC_EVENT_RESUMECHAT")&&H!==K){J.SetProperty(r.get("CHATUISVC_TAG_NEEDTYPEINFO"),"TRUE")}this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_UPDATECHATDATA"),J);o.call(this,H)}function g(F){var I=F.GetPropertyAsStr(r.get("CHATUISVC_TAG_CURRCHATID"));var G=F.GetPropertyAsStr(r.get("CHATUISVC_TAG_EVENTCHATID"));
var J=F.Clone();var H=this.ExecuteMethod("GetCurrChatId");if(H){t.call(this,H,r.get("CHATCC_METADATA_CTRLNAME_TEXT"),J);t.call(this,H,r.get("CHATCC_METADATA_CTRLNAME_URL"),J)}if(G!==I){J.SetProperty(r.get("CHATUISVC_TAG_EVENTCHATID"),"")}this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_UPDATECHATDATA"),J)}function x(G){var H=G.GetPropertyAsStr(r.get("CHATUISVC_TAG_CURRCHATID"));var F=this.Get("CurrentChat");var I=G.Clone();if(H&&F&&F.Id===H){if(w(F)){I.SetProperty(r.get("CHATUISVC_TAG_EVENTCHATID"),H);this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_REMOVECHATDATA"),I)}else{t.call(this,H,r.get("CHATCC_METADATA_CTRLNAME_TEXT"),I);t.call(this,H,r.get("CHATCC_METADATA_CTRLNAME_URL"),I);this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_SAVEINPUTFIELDS"),I)}A.call(this,H)}}function E(H,F){p(3,"OnSwitchChat: "+H+", "+F);var G=CCFMiscUtil_CreatePropSet();G.SetPropertyStr(r.get("CHATUISVC_TAG_CURRCHATID"),H);G.SetPropertyStr(r.get("CHATUISVC_TAG_NEWSELECTEDCHATID"),F);this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_SWITCHCHAT"),G)}function h(L,M){var K=this.Get("CurrentChat");if(!K){return}var H=K.Id;var I=this.Get("ChatTabMap");var J=I[H];if(J){if(z.IsEmpty(M)){M=true}if(!M){this.SetProperty("ChatClearLog",{chatId:H})}var F=this,G=0;$($.parseXML(L)).find("message, pushurl, system-message").each(function(){G++;if(!M||G>J.transcriptCnt){var S=$(this).context.nodeName.toUpperCase(),P=$(this).attr("userName"),O=$(this).attr("timestamp"),Q=($(this).attr("from")==="agent"),R=$.trim($(this).text());switch(S){case"MESSAGE":var N={chatId:H,userName:P,text:R,timestamp:O,FromAgent:Q};F.SetProperty("NewChatMessage",N);break;case"PUSHURL":break;case"SYSTEM-MESSAGE":var N={chatId:H,userName:"System Message",text:R,timestamp:O,FromAgent:false};F.SetProperty("NewChatMessage",N);break;default:break}}});J.transcriptCnt=G;if(G>0){F.SetProperty("ReadLastMessage",H)}}}function q(G){for(var H=0,F=G.GetChildCount();H<F;H++){var I=G.GetChild(H);if(I.GetType()===r.get("CHAT_PST_TYPE_LOCALE")){this.AddProperty("LocaleInfo",b.call(this,I))}}}function b(J){if(J.GetType()!==r.get("CHAT_PST_TYPE_LOCALE")){return}var I=true;var L;var G;var K={};for(var H=0,F=J.GetPropertyCount();H<F;H++){if(I){L=J.GetFirstProperty();I=false}else{L=J.GetNextProperty()}G=J.GetProperty(L);if(L===r.get("CHAT_PANE_CAPTION")){K.CAPTION=G}}return K}function f(){k.call(this);this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_INITIALIZEAX"));var F=CCFMiscUtil_CreatePropSet();F.SetProperty(r.get("CHATUISVC_TAG_NEEDTYPEINFO"),"TRUE");this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_UPDATECHATDATA"),F)}function m(H){D.call(this,H);var I=H.GetProperty(r.get("CHATUISVC_TAG_TRANSCRIPT"));h.call(this,I,false);var K=this.Get("CurrentChat");if(K){var G=K[r.get("CHATCC_METADATA_CTRLNAME_TEXT")];this.ExecuteMethod("GetTextInputValue",K.Id);var J=this.Get("TextInput4Get");if(!J){this.SetProperty("TextInput4Set",G)}var L=K[r.get("CHATCC_METADATA_CTRLNAME_URL")];this.ExecuteMethod("GetUrlInputValue",K.Id);var F=this.Get("UrlInput4Get");if(!F){this.SetProperty("UrlInput4Set",L)}}}function D(G){if(!G){return}var L=this.Get("ChatTabMap");var J=G.GetProperty(r.get("CHATUISVC_TAG_CURRCHATID"));var K=G.GetProperty(r.get("CHATUISVC_TAG_CURRCHATONHOLD"));var F=null;for(var I=0;I<G.GetChildCount();I++){F=G.GetChild(I);if(F&&F.GetType()==="Tab"){var H=F.GetProperty(r.get("CHATUISVC_TAG_CHATID"));var M=L[H];if(!M){M={Id:H,agentTypingSentTime:0,transcriptCnt:0};L[H]=M}i(M,F);if(w(M)&&H!==J){c.call(this,H)}else{this.SetProperty("ChatUpdated",M)}if(H===J){this.SetProperty("CurrentChat",M);if(K&&!w(M)){A.call(this,H)}}}}this.SetProperty("ChatTabMap",L)}function i(K,G){var J=G.GetProperty(r.get("CHATUISVC_TAG_CAPTION"));var I=G.GetProperty(r.get("CHATUISVC_TAG_NEWMESSAGECOUNT"));var H=G.GetProperty(r.get("CHATUISVC_TAG_LASTMESSAGE"));var L=G.GetProperty(r.get("CHATUISVC_TAG_CHATSTATE"));K.state=L;K.caption=J;K.newMsgCnt=I;if(I>0){K.newMsg=H}var F=G.GetChildByType(r.get("CHATUISVC_TAG_TYPE_FIELD"));if(F){var M=F.EnumProperties(true);do{K[M]=F.GetProperty(M)}while((M=F.EnumProperties(false)))}}function w(F){return(F.state===r.get("CHATUISVC_CHATSTATE_TERMINATE"))}function A(I,H){var J=this.Get("ChatTabMap")[I];if(!J){p(1,"Holding chat info not found!");return}var G=this.Get("CurrentTabOnHold");if(!G){this.SetProperty("CurrentTabOnHold",J);G=J;this.SetProperty("ChatIdHold",I)}var F=this.Get("CurrentChat");if(F!==G){p(1,"Holding chat is not current!");return}if(!H&&w(J)){c.call(this,I,true);this.SetProperty("CurrentTabOnHold",null);this.SetProperty("CurrentChat",null)}}function o(F){var G=this.Get("ChatTabMap")[F];if(!G){p(1,"Resuming chat info not found!");return}this.SetProperty("CurrentTabOnHold",null);this.SetProperty("CurrentChat",G);this.SetProperty("ChatResumed",G)}function c(G,F){if(G){this.SetProperty("ChatIdRemoved",G);var H=this.Get("ChatTabMap");if(H.hasOwnProperty(G)){delete H[G];if(!F){var I=CCFMiscUtil_CreatePropSet();I.SetProperty(r.get("CHATUISVC_TAG_EVENTCHATID"),G);this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_REMOVECHATDATA"),I)}}}}function B(F){var J=F.GetPropertyAsStr(r.get("CHATUISVC_TAG_CURRCHATID"));var H=this.Get("CurrentChat");if(!H){p(1,"Fatal error, current chat is invalid!");return}var I=H.Id;if(J!==I){p(1,"Current chat id does not match!")}var G=F.Clone();G.SetPropertyStr(r.get("CHATUISVC_TAG_DATA_FIELD"),r.get("CHATUISVC_TAG_TRANSCRIPT"));G.SetPropertyStr(r.get("CHATUISVC_TAG_APPEND"),r.get("CHATUISVC_VALUE_YES"));this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_GETFIELDDATA"),G)}function u(F){}function y(F){}function t(I,K,G,H){if(K===r.get("CHATCC_METADATA_CTRLNAME_TEXT")){this.ExecuteMethod("GetTextInputValue",I);var F=this.Get("TextInput4Get");G.SetPropertyStr(r.get("CHATCC_METADATA_CTRLNAME_TEXT"),F);if(H){this.SetProperty("TextInput4Set","")}}else{if(K===r.get("CHATCC_METADATA_CTRLNAME_URL")){this.ExecuteMethod("GetUrlInputValue",I);var J=this.Get("UrlInput4Get");G.SetPropertyStr(r.get("CHATCC_METADATA_CTRLNAME_URL"),J);if(H){this.SetProperty("UrlInput4Set","")}}}}function p(G,F){a(G,"chatpmodel.js: "+F)}function a(G,F){SiebelApp.S_App.CommToolbarUtil.Log(G,F)}function l(){var G=CCFMiscUtil_CreatePropSet();G.SetProperty(r.get("SWE_VIEW_ID_STR"),r.get("CHAT_PANE_VIEWNAME"));G.SetPropertyStr("SWEBS","1");var F=this.ExecuteMethod("GetCurrChatId");if(F){t.call(this,F,r.get("CHATCC_METADATA_CTRLNAME_TEXT"),G);t.call(this,F,r.get("CHATCC_METADATA_CTRLNAME_URL"),G)}this.ExecuteMethod("InvokeServiceMethod",r.get("CHATUISVC_METHOD_TOGGLECHATPANE"),G)}function n(){var F=true;var I=App();if(I===undefined||I===null){p(2,"App() failed!");return F}var G=App().GetMainView();if(G===undefined||G===null){p(2,"No main view found!");return F}var H=G.GetActiveApplet();if(H===undefined||H===null){p(2,"No active applet found!");return F}F=H.InvokeMethod("ImplicitCommit",CCFMiscUtil_CreatePropSet());return F}return e}())};