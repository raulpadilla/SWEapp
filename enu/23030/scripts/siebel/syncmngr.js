if(typeof(SiebelApp.SyncMgr)==="undefined"){SiebelJS.Namespace("SiebelApp.SyncMgr");SiebelApp.SyncMgr=(function(){var k;var o=SiebelApp.OfflineCacheConfig;var b=SiebelApp.Offlineconstants;var j=SiebelApp.Constants;var n=SiebelApp.Utils;var g=b.get("SYNC_REQUEST_LIMIT");var m=[];var a=0;var p=[];var f=-1;var e="";var d=0;var l;var c;var h={};function i(){var q;r=function r(){return q};r.prototype=this;q=new r();q.constructor=r;return q}k=new i();i.prototype.UpSync=function(q){SiebelApp.BrowserCacheMgr.GetItemsToSync(q,function(s){if(s){if(s.length!==0){if(s[0].TransactionId){SiebelApp.SyncMgr.PurgeProSync(q);return SiebelApp.SyncMgr.ProactiveSyncRequestBuilder(s)}else{var t;if(SiebelApp.S_App.uiStatus.IsBusy()){SiebelApp.S_App.uiStatus.Free()}for(var r=0;r<s.length;r++){h=s[r];t=h.Request;t=SiebelApp.SyncMgr.BuildUpSync(t);SiebelApp.SyncMgr.PendingRequest(o.get("PRO_SYNCQUEUE_DB_TBL"),h.RecordNum,t)}}}else{alert("No Data to be Synchronized");if(SiebelApp.S_App.uiStatus.IsBusy()){SiebelApp.S_App.uiStatus.Free()}}}else{alert("No Data to be Synchronized");if(SiebelApp.S_App.uiStatus.IsBusy()){SiebelApp.S_App.uiStatus.Free()}}})};i.prototype.BuildUpSync=function(q){var y=q;var t;var w;var x;var v;var u=j.get("SWE_PROP_SESSION_RANDOM_NUMBER");t=SiebelApp.S_App.GetSRN();y=unescape(y);if(y.search(t)===-1){x=y;v=x.split("&");for(var s=0;s<v.length;s++){var r=v[s].split("=");if(r[0]===u){w=unescape(r[1]);y.replace(w,t);return y}}}return y};i.prototype.PendingRequest=function(r,t,q){var s={};s.url=q;s.type="GET";s.async=false;s.successfncallback=function(w,x,v){if(w.search("Error")!==-1){SiebelJS.Log("Cannot Sync Request "+q+" ")}else{if(w!==null&&w!==" "){SiebelApp.S_App.ProcessResponse(w);var u=o.get("PRO_SYNCQUEUE_DB_TBL_COLS");SiebelApp.BrowserCacheMgr.Delete(r,u.Request,q)}else{SiebelApp.S_App.SyncMgr.ErrorHandler()}}};SiebelApp.AjaxRequestMgr.Ajax(s,false)};i.prototype.ProactiveSyncRequestBuilder=function(x){var t;var y="~";var z="";var B=0;var C=0;var A;var q;var D;var s;if(x.length<g&&d<1){e="Completed";C=1;for(var w=0;w<x.length;w++){t="";h=x[w];A=(h.Request.split("?"));q=A[0].length;t=h.Request.substring(q+1);t=t.concat("&","TxnId=",h.TransactionId);t=encodeURIComponent(t);z=z.concat(t,y);B++}if(z){z=z.slice(0,((z.length)-1));D=SiebelApp.S_App.GenerateSrvrReq("SynchronizeOfflineData");s=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(D,[b.get("SYNC_PKG_LENGTH"),b.get("TOTAL_SYNC_PACKAGE_LENGTH"),b.get("SYNC_PKG_REQUESTS"),j.get("SYNC_NODE_ID"),b.get("END_OF_FILE")],[B,x.length,z,SiebelApp.BrowserCacheMgr.GetSyncNodeId(),C]);SiebelApp.AjaxRequestMgr.Post(s)}}else{d=d+1;c={};var r=[];for(var v=0;v<x.length;v++){if(x[v].SyncStatus!=="Received"){r.push(x[v])}}if(r.length<=g){e="Completed";g=r.length}else{e="Pending"}for(var u=0;u<g;u++){h=r[u];c[u]=r[u];t="";A=(h.Request.split("?"));q=A[0].length;t=h.Request.substring(q+1);t=t.concat("&","TxnId=",h.TransactionId);t=encodeURIComponent(t);z=z.concat(t,y);B++}if(z){if(e==="Completed"){C=1;d=0}z=z.slice(0,((z.length)-1));D=SiebelApp.S_App.GenerateSrvrReq("SynchronizeOfflineData");s=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(D,[b.get("SYNC_PKG_LENGTH"),b.get("TOTAL_SYNC_PACKAGE_LENGTH"),b.get("SYNC_PKG_REQUESTS"),j.get("SYNC_NODE_ID"),b.get("END_OF_FILE")],[B,x.length,z,SiebelApp.BrowserCacheMgr.GetSyncNodeId(),C]);SiebelApp.AjaxRequestMgr.Post(s)}}if(!z){alert("No Data to be Synchronized");if(SiebelApp.S_App.uiStatus.IsBusy()){SiebelApp.S_App.uiStatus.Free()}}};i.prototype.ProcessAck=function(r){if(r!==null&&r!==" "){var s=CCFMiscUtil_CreatePropSet();s.DecodeFromString(r);if(s.propArray.Chunk_Status){if(s.propArray.Chunk_Status!=="OK"){SiebelJS.Log(s.propArray.Chunk_Status);alert("Not abel to Sync, Please try after some time");if(SiebelApp.S_App.uiStatus.IsBusy()){SiebelApp.S_App.uiStatus.Free()}}else{if(d>=1&&e==="Pending"){SiebelApp.SyncMgr.UpdateCallBack(0)}else{if(s.propArray.Generic_SyncErr!=="OK"){alert(s.propArray.Generic_SyncErr)}else{var q=CCFMiscUtil_CreatePropSet();q.DecodeFromString(s.propArray.Status_Sync);SiebelJS.Log(s.propArray.Status_Sync);alert("Sync is successfully done, Please contact administrator to verify logs.");SiebelApp.ProactiveCacheBuilder.ProcessGoOnline()}SiebelApp.S_App.uiStatus.Free()}}}}else{SiebelApp.SyncMgr.ErrorHandler()}};i.prototype.UpdateCallBack=function(q){SiebelApp.BrowserCacheMgr.UpdateSyncQueue(["Received"],"TransactionId",c[q].TransactionId,q,function(r){r++;if(r<g){SiebelApp.SyncMgr.UpdateCallBack(r)}else{SiebelApp.SyncMgr.UpSync(l)}})};i.prototype.ErrorHandler=function(){SiebelJS.Log("Not able to sync pending request")};i.prototype.LoadOfflinePackage=function(w,s){if(s){SiebelApp.ProactiveCacheBuilder.ParseAndCacheData(w)}else{var r=SiebelApp.OfflineUtils.GetOfflineCacheConfig(o.get("PRO_METADATASTORE_DB"));var u=r.tables;u.push("PickListInfo");u.push("BCPartners");if(u){var v=u.length;for(var x=0;x<v;x++){SiebelApp.BrowserCacheMgr.DeleteTable(u[x])}}var q=["StringCache","ViewList","cmdMap","SyncNodeId","SRFId"];var t;for(t in localStorage){if(q.indexOf(t)!==-1){localStorage.removeItem(t)}}SiebelApp.ProactiveCacheBuilder.ParseAndCacheMetadata(w)}};i.prototype.GenDataPkgReq=function(q){var r=SiebelApp.S_App.GenerateSrvrReq("GetOfflineData");if(typeof(q)!=="undefined"){r=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(r,[b.get("VIEW_LIST")],[q])}r=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(r,[j.get("SYNC_NODE_ID")],[SiebelApp.BrowserCacheMgr.GetSyncNodeId()]);return r};i.prototype.GetNextViewData=function(r){var q=p[f];if(r.search("Schema")===-1){SiebelJS.Log("Error getting data for "+q);SiebelJS.Log("Response received for "+q+":"+r)}else{SiebelJS.Log("Received Data for View: #"+f+"-"+q)}f++;if(p&&f>=0&&f<p.length){var s=SiebelApp.SyncMgr.GenDataPkgReq(p[f]);SiebelApp.AjaxRequestMgr.Get(s,SiebelApp.SyncMgr.GetNextViewData)}else{SiebelApp.S_App.uiStatus.Free();SiebelJS.Log("Getting Offline Data Package....is Done.");SiebelApp.OfflineAppSettings.SetMode((!SiebelApp.OfflineAppSettings.GetMode()));SiebelApp.OfflineAppSettings.SetData(true)}SiebelApp.OfflineUtils.Log("Parsing and Caching Data for view: "+q);SiebelApp.SyncMgr.LoadOfflinePackage(r,true)};i.prototype.GetOFDataPkg=function(s){SiebelApp.S_App.uiStatus.Busy({mask:true,timeOut:false});SiebelJS.Log("Getting Offline Data Package...."+SiebelApp.OfflineUtils.GetTS());s=(typeof s==="undefined")?b.get("GET_DATA_PKG_MODE_ALL"):s;var t;p=SiebelApp.BrowserCacheMgr.GetViewList();var q=p.length;switch(s){case b.get("GET_DATA_PKG_MODE_VIEW_BY_VIEW"):if(!n.IsEmpty(p)){SiebelApp.OfflineUtils.Log("Getting Offline Data Package View by View for below list of "+q+" views: ");SiebelApp.OfflineUtils.Log(JSON.stringify(p));if(q){f=0;t=SiebelApp.SyncMgr.GenDataPkgReq(p[f]);SiebelApp.AjaxRequestMgr.Get(t,SiebelApp.SyncMgr.GetNextViewData)}}else{SiebelJS.Log("Unable to get data as Metadata is not available. There was a failure in getting Metadata")}break;case b.get("GET_DATA_PKG_MODE_ALL_IN_METADATA"):var r=JSON.stringify(p);r=r.replace(/\[/g,"");r=r.replace(/\]/g,"");
r=r.replace(/\,/g,"|");r=r.replace(/\"/g,"");SiebelApp.OfflineUtils.Log("Getting Offline Data Package Views: "+r);t=SiebelApp.SyncMgr.GenDataPkgReq(r);SiebelApp.AjaxRequestMgr.Get(t,SiebelApp.AjaxRequestMgr.ProcessToolbarResponse);break;default:t=SiebelApp.SyncMgr.GenDataPkgReq();SiebelApp.AjaxRequestMgr.Get(t,SiebelApp.AjaxRequestMgr.ProcessToolbarResponse);break}};i.prototype.AddParam=function(r,t,q,s){r.SetProperty(j.get("SWE_PST_BUSCOMP_INFO"),t);r.SetProperty(j.get("SWE_PST_BUSOBJ_INFO"),q);if(s){r.SetProperty(b.get("NEW_APP_TAG_INFO"),s)}return r};i.prototype.BuildRequest=function(x){var s={};var t=[];var P=[];var L=[];var O=[];var y=[];var E=[];var C=[];var r=[];var u;var B;var z=x.indexOf("?");var q;q=SiebelApp.OfflineDataMgr.GetTempId();z=z+1;B=x.substring(0,z);var F=x.substring(z,x.length);E=F.split("&");for(var M=0;M<E.length;M++){if(E[M].search("OF_")!==-1){L.push(E[M])}else{if((E[M].search("s_")!==-1)&&(E[M].search("SWE")===-1)){t.push(E[M])}else{P.push(E[M])}}}for(var K=0;K<L.length;K++){O.push(L[K].split("="))}for(var J=0;J<O.length;J++){var w={};for(var N=0;N<O[J].length;N++){w.FieldName=O[J][N];N=N+1;w.Value=O[J][N]}y.push(w)}if(m.length!==0){for(var H=0;H<y.length;H++){for(var G=0;G<m.length;G++){if(decodeURIComponent(y[H].FieldName)===m[G].name){C.push(y[H].FieldName+"="+m[G].oldvalue+"|"+y[H].Value)}}}m=[]}else{if((x.search("SWEMethod=PickRecord"))!==-1&&m.length===0){C=[];for(var A=0;A<y.length;A++){C.push(y[A].FieldName+"=|"+y[A].Value)}}}for(var D=0;D<P.length;D++){if(P[D].search("SWECmd")===-1&&P[D].search("SWEVI")===-1&&P[D].search("SWEReqRowId")===-1&&P[D].search("SWENeedContext")===-1&&P[D].search("SWEC")===-1&&P[D].search("SWERPC")===-1&&P[D].search("SRN")===-1){r.push(P[D])}}for(var I=0;I<r.length;I++){C.push(r[I])}u=C.join("&");u=B+u;s.request=u;s.txnid=q;return s};i.prototype.PassOldValue=function(q,t,s){var r={};r.name="OF_"+q.split(" ").join("+");r.oldvalue=t.split(" ").join("+");r.newvalue=s.split(" ").join("+");m.push(r)};i.prototype.ProcessLastTxn=function(q,t){var v=CCFMiscUtil_CreatePropSet();v.DecodeFromString(t);if(v.propArray.Status!=="OK"){SiebelJS.Log(v.propArray.Status);if(a<b.get("RETRY_UPSYNC_REQUEST")){SiebelApp.AjaxRequestMgr.Get(q);a=a+1}else{alert("Login session got expired, Please close the browser and login again to sync");SiebelApp.OfflineAppSettings.ReloadApp()}}else{l=v.propArray.TxnId;var u=l.indexOf(">");var r=l.substr(u+1,l.length);var s=r.indexOf("<");l=r.substr(0,s);SiebelApp.SyncMgr.UpSync(l);SiebelApp.S_App.uiStatus.Busy({target:SiebelApp.S_App.GetTargetViewContainer(),mask:true,timeOut:false})}};i.prototype.PurgeProSync=function(s){var q=o.get("PRO_SYNCQUEUE_DB_TBL");var r=o.get("PRO_SYNCQUEUE_DB_TBL_COLS");SiebelApp.BrowserCacheMgr.Delete(q,r.TransactionId,s)};return k}())};