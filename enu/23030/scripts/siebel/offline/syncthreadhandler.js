/*<ORACLECOPYRIGHT>
* Copyright (C) 1994-2013 Oracle and/or its affiliates. All rights reserved.
* Oracle and Java are registered trademarks of Oracle and/or its affiliates.
* Other names may be trademarks of their respective owners.
* UNIX is a registered trademark of The Open Group.
*
* This software and related documentation are provided under a license agreement
* containing restrictions on use and disclosure and are protected by intellectual property laws.
* Except as expressly permitted in your license agreement or allowed by law, you may not use, copy,
* reproduce, translate, broadcast, modify, license, transmit, distribute, exhibit, perform, publish,
* or display any part, in any form, or by any means. Reverse engineering, disassembly,
* or decompilation of this software, unless required by law for interoperability, is prohibited.
*
* The information contained herein is subject to change without notice and is not warranted to be error-free.
* If you find any errors, please report them to us in writing.
*
* U.S. GOVERNMENT RIGHTS Programs, software, databases, and related documentation and technical data delivered to U.S.
* Government customers are "commercial computer software" or "commercial technical data" pursuant to the applicable
* Federal Acquisition Regulation and agency-specific supplemental regulations.
* As such, the use, duplication, disclosure, modification, and adaptation shall be subject to the restrictions and
* license terms set forth in the applicable Government contract, and, to the extent applicable by the terms of the
* Government contract, the additional rights set forth in FAR 52.227-19, Commercial Computer Software License
* (December 2007). Oracle America, Inc., 500 Oracle Parkway, Redwood City, CA 94065.
*
* This software or hardware is developed for general use in a variety of information management applications.
* It is not developed or intended for use in any inherently dangerous applications, including applications that
* may create a risk of personal injury. If you use this software or hardware in dangerous applications,
* then you shall be responsible to take all appropriate fail-safe, backup, redundancy,
* and other measures to ensure its safe use. Oracle Corporation and its affiliates disclaim any liability for any
* damages caused by use of this software or hardware in dangerous applications.
*
* This software or hardware and documentation may provide access to or information on content,
* products, and services from third parties. Oracle Corporation and its affiliates are not responsible for and
* expressly disclaim all warranties of any kind with respect to third-party content, products, and services.
* Oracle Corporation and its affiliates will not be responsible for any loss, costs,
* or damages incurred due to your access to or use of third-party content, products, or services.
</ORACLECOPYRIGHT>*/
if(typeof(SiebelApp.SyncThreadHandler)==="undefined"){SiebelJS.Namespace("SiebelApp.SyncThreadHandler");SiebelApp.SyncThreadHandler=(function(){var t=0;var s;var c;var b;var e;var d;var w;var o;var n;var u;var q;var a="";var h="";var j=window.location.origin;var x="";var y=-1;var k=false;var g=0;var p=SiebelApp.Constants;var r=SiebelApp.Offlineconstants;var l=SiebelApp.OfflineAppSettings;var m=window.location;function f(){var z;A=function A(){return z};A.prototype=this;z=new A();z.constructor=A;return z}var v=new f();f.prototype.SyncInProgress=function(){return(t>0)};f.prototype.OnCall=function(F,I,G){var J=SiebelApp.S_App.GetScriptDir()+"siebel/offline/syncwebworker.js";var D=new Worker(J);var K;var B;var z=window.location.protocol;SiebelApp.S_App.uiStatus.Free();var A=SiebelApp.BrowserCacheMgr.GetSyncNodeId();q=SiebelApp.S_App.GetUserName();u=m.pathname.replace("start.swe","");u=u.replace(/\//g,"");u=u+"_sync";if(!k){k=l.GetPkgStatus()}if(t===0){if(h===""){h=F.pwd;if(h===""){D.terminate();return}}t=1;F.url=j+"/";F.url=F.url+u+"/start.swe";x=F.url;var L=x;var C=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(L,[p.get("SWE_CMD_ARG"),"IsPortlet","SWEPassword","SWEUserName"],["ExecuteLogin",1,h,q],"",x);F.url=C;var H=C.indexOf("?");var E=C.substring(H+1,C.length);F.url=x;F.data=E;F.async=false;F.contentType="application/x-www-form-urlencoded";F.type="POST";h="";F.pwd=""}F.url=F.url.replace(F.url.substring(F.url.indexOf(z),F.url.indexOf(u)-1),window.location.origin);D.postMessage(F);if(I){I.apply(this,G)}D.addEventListener("message",function(T){if(T.data[1]==="OK"){var aa="";this.url=T.data[2];b=T.data[0];var Y;if(t===1){Y=true}else{Y=false}if(t===12||SiebelApp.OfflineAppMgr.CheckServerConnection(b,Y)){switch(t){case 1:var R=b;e=b.search("_sn");b=b.substring(e);e=b.search("_sn");d=b.indexOf("&");s=b.substring(e,d);b=b.substring(d+1);e=b.search("SRN");b=b.substring(e);e=b.search("SRN");d=b.indexOf("&");if(d===-1){d=b.indexOf(" ");d=d-1;K=R.indexOf(z);R=R.substring(K);K=R.indexOf(z);B=R.indexOf(" ");F.url=R.substring(K,B-1);t=t+1}c=b.substring(e,d);var U=c.split("=");if(U[0]!=="SRN"||U[1]===""||U.length!==2){alert(SiebelApp.S_App.OfflineLocaleObject.GetLocalString("IDS_SWE_INVALID_OLD_PASSWORD"));D.terminate();t=0;return}if((l.GetMode()===false)&&(k===false)){$("#_swecontent").prepend("<div id='progressbar' class ='progressbar'><img class = 'goOffline'src='images/white.gif'></img></div>")}F.data="";F.type="GET";D.terminate();SiebelApp.SyncThreadHandler.OnCall(F);break;case 2:t=t+1;e=b.search("src=");b=b.substring(e);e=b.search("src=");d=b.indexOf("SWETS=");if(d===-1){d=b.indexOf(" ");d=d-1;F.url=b.substring(e+5,d)}else{F.url=b.substring(e+5,d+6)}b=b.substring(d);e=b.indexOf("_sweattachment");b=b.substring(e);e=b.search("src=");b=b.substring(e);e=b.search("src=");d=b.indexOf("SWETS=");if(d===-1){d=b.indexOf(" ");d=d-1;w=b.substring(e+5,d)}else{w=b.substring(e+5,d+6)}D.terminate();SiebelApp.SyncThreadHandler.OnCall(F);break;case 3:F.url=w;t=t+1;K=b.indexOf(z);b=b.substring(K);K=b.indexOf(z);B=b.indexOf(")");o=b.substring(K,B-1);b=b.substring(B);K=b.indexOf("_sweclient`v`");b=b.substring(K+15);K=b.indexOf("?");B=b.indexOf("`");n=b.substring(K+1,B);D.terminate();SiebelApp.SyncThreadHandler.OnCall(F);break;case 4:F.url=o;t=t+1;if(l.GetSyncStatus()===false){t=t+2;if(k===true){t=t+1}}D.terminate();SiebelApp.SyncThreadHandler.OnCall(F);break;case 5:t=t+1;SiebelApp.S_App.CustomToolbar.Update("UpSync");$("#_swecontent").prepend("<div id='progressbar' class ='progressbar'><img class = 'appCacheProgress1'src='images/white.gif'></img></div>");aa=x;var O=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(aa,[p.get("SWE_CMD_ARG"),p.get("SWE_ARG_KEEP_CONTEXT"),p.get("SWE_VIEW_RPC_ARG"),p.get("SYNC_NODE_ID")],["GetLastTxn",1,1,A],"",x);O=O+"&"+c;F.url=O;SiebelJS.Log("Getting Last Transaction Id....");D.terminate();SiebelApp.SyncThreadHandler.OnCall(F);$(".progressbar").find("img").removeClass().addClass("appCacheProgress2");break;case 6:y=t;if(k===true){t=11}aa=x;O=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(aa,[p.get("SWE_CMD_ARG"),p.get("SWE_ARG_KEEP_CONTEXT"),p.get("SWE_VIEW_RPC_ARG"),p.get("SYNC_NODE_ID")],["SynchronizeOfflineData",1,1,A],"",x);F.url=O;var V=SiebelApp.SyncThreadHandler.ProcessUpSync(F.url,b,function(ad){F.url=ad;var ac=ad.indexOf("?");var ab=ad.substring(ac+1,ad.length);F.url=x+"?"+c;F.data=ab;F.async=false;F.contentType="application/x-www-form-urlencoded";F.type="POST";D.terminate();SiebelApp.SyncThreadHandler.OnCall(F)});if(!V){D.terminate()}break;case 7:if(!l.GetPkgStatus()&&l.GetMetadata()){A="";window.localStorage.setItem(p.get("SYNC_NODE_ID"),"")}t=t+1;aa=x;O=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(aa,[p.get("SWE_CMD_ARG"),p.get("SWE_ARG_KEEP_CONTEXT"),p.get("SWE_VIEW_RPC_ARG"),p.get("SYNC_NODE_ID"),r.get("REGENERATEMETADATA")],["GoOffline",1,1,A,g],"",x);O=O+"&"+c;F.url=O;SiebelApp.S_App.CustomToolbar.Update("FullDownLoad");SiebelJS.Log("Getting Offline Metadata...."+SiebelApp.OfflineUtils.GetTS());D.terminate();g=0;SiebelApp.SyncThreadHandler.OnCall(F);break;case 8:V=true;var P={};if(k===false){P=SiebelApp.AjaxRequestMgr.ProcessToolbarResponse.apply(this,T.data);V=P.bContinue}if(A===""){A=SiebelApp.BrowserCacheMgr.GetSyncNodeId()}if(V){aa=x;O=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(aa,[p.get("SWE_CMD_ARG"),p.get("SWE_ARG_KEEP_CONTEXT"),p.get("SWE_VIEW_RPC_ARG"),p.get("SYNC_NODE_ID"),"LastSyncTimeStamp"],["GetOfflineData",1,1,A,window.localStorage.getItem("TS")],"",x);O=O+"&"+c;if(k){SiebelApp.S_App.CustomToolbar.Update("IncDataDownLoad");SiebelJS.Log("Getting Incremental Data Package...."+SiebelApp.OfflineUtils.GetTS());O=O+"&iSync=1";O=O+"&SRFId="+window.localStorage.getItem("SRFId")}else{SiebelApp.S_App.CustomToolbar.Update("FullDownLoad");SiebelJS.Log("Getting Offline Data Package...."+SiebelApp.OfflineUtils.GetTS())}F.url=O;if(!k){t=t+2}else{t=t+1}D.terminate();if(P.callback){SiebelApp.SyncThreadHandler.OnCall(F,P.callback,P.args)}else{SiebelApp.SyncThreadHandler.OnCall(F)}}else{t=0;D.terminate()}break;case 9:var N=["IDS_DOUI_ERR_DATA_OUTDTD","IDS_DOUI_ERR_NODECHANGED_BKUP_DATA","IDS_DOUI_ERR_SRF_EXPIRED","IDS_DOUI_ERR_RESP_CHNG","IDS_DOUI_ERR_UPOSCHANGED_BKUP_DATA"];var X=["Data_OutDated","Node_ReExtracted","SRF_Changed","Responsibilty_Changed","Position_Changed"];var W=CCFMiscUtil_CreatePropSet();W.DecodeFromString(b);var Z=W.GetType();if(Z){Z=Z.toString()}var M=X.indexOf(Z);if(M!==-1){y=9;var Q=N[M];var S=SiebelApp.S_App.OfflineLocaleObject.GetLocalString(Q);alert(S);t=7;y=-1;k=false;l.SetData(false);l.SetMetadata(false);$("#_swecontent").prepend("<div id='progressbar' class ='progressbar'><img class = 'goOffline'src='images/white.gif'></img></div>");if(M>1){l.SetSchemaStatus(1);if(M>2){g=1}}SiebelApp.SyncThreadHandler.OnCall(F);D.terminate()}else{$("#_swecontent").prepend("<div id='progressbar' class ='progressbar'><img class = 'goOffline'src='images/white.gif'></img></div>");SiebelApp.AjaxRequestMgr.ProcessToolbarResponse.apply(this,T.data);aa=x;O=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(aa,[p.get("SWE_CMD_ARG"),p.get("SWE_ARG_KEEP_CONTEXT"),p.get("SWE_VIEW_RPC_ARG"),p.get("SYNC_NODE_ID"),"ACK","LastSyncTimeStamp","iSync"],["GetOfflineData",1,1,A,1,window.localStorage.getItem("TS"),1],"",x);
O=O+"&"+c;F.url=O;t=t+2;D.terminate();SiebelApp.SyncThreadHandler.OnCall(F)}break;case 10:SiebelApp.AjaxRequestMgr.ProcessToolbarResponse.apply(this,T.data);t=t+1;aa=x;O=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(aa,[p.get("SWE_CMD_ARG"),p.get("SWE_ARG_KEEP_CONTEXT"),p.get("SWE_VIEW_RPC_ARG"),p.get("SYNC_NODE_ID"),"ACK","LastSyncTimeStamp","iSync"],["GetOfflineData",1,1,A,1,window.localStorage.getItem("TS"),0],"",x);O=O+"&"+c;F.url=O;D.terminate();SiebelApp.SyncThreadHandler.OnCall(F);break;case 11:t=t+1;aa=x;O=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(aa,[p.get("SWE_CMD_ARG"),"SWEPreLd"],["Logoff",1],"",x);O=O+"&"+c;if(y===6){l.SetSyncStatus(false);l.SetMode(false);SiebelApp.S_App.CustomToolbar.Update("UpSyncDone");$(".progressbar").find("img").removeClass().addClass("appCacheProgress6");SiebelJS.Log("Synchronizing offline data... is Done");F.data="";F.type="GET"}F.url=O;D.terminate();SiebelApp.SyncThreadHandler.OnCall(F);break;case 12:if(y===6){if(l.GetSyncStatus()===true){SiebelApp.S_App.CustomToolbar.Update("UpSyncFailed");$(".progressbar").remove()}else{SiebelApp.S_App.CustomToolbar.Update("UpSyncDone");$(".progressbar").find("img").removeClass().addClass("appCacheProgress6")}D.terminate();l.ReloadApp()}if(y===9){l.SetMode(false);$("div #GoOffline").find(".stati").removeClass("statusIncDataDownLoad");t=0;y=-1;D.terminate()}}}else{i.call(this)}D.terminate()}else{i.call(this)}},false);return};function i(){if(t!==12){if(!l.GetMode()&&l.GetPkgStatus()){l.OnSuccessfulDataDownload();m.replace(m.origin.concat(m.pathname))}else{alert(SiebelApp.S_App.OfflineLocaleObject.GetLocalString("IDS_DOUI_ERR_SYNC"))}t=0}}f.prototype.ProcessUpSync=function(z,C,F){var E=CCFMiscUtil_CreatePropSet();E.DecodeFromString(C);if(SiebelApp.OfflineAppMgr.CheckValidation(E)){if(E.propArray.Status!=="OK"){SiebelJS.Log(E.propArray.Status);return false}else{a=E.propArray.TxnId;var D=a.indexOf(">");var A=a.substr(D+1,a.length);var B=A.indexOf("<");a=A.substr(0,B);SiebelJS.Log("Last Transaction Id...."+a);SiebelJS.Log("Synchronizing offline data....");SiebelApp.SyncThreadHandler.UpSync(z,a,F);$(".progressbar").find("img").removeClass().addClass("appCacheProgress3");return true}}else{return false}};f.prototype.UpSync=function(z,A,B){SiebelApp.BrowserCacheMgr.GetItemsToSync(A);$.callback(this,function(D){var C=D.retVal;if(C){if(C.length!==0){if(A!==""){SiebelApp.SyncThreadHandler.PurgeRecord(A)}$.callback(this,function(){var E=SiebelApp.SyncThreadHandler.SyncRequestBuilder(z,C);B.apply(this,[E])})}}})};f.prototype.PurgeRecord=function(B){var z=SiebelApp.OfflineCacheConfig.get("PRO_SYNCQUEUE_DB_TBL");var A=SiebelApp.OfflineCacheConfig.get("PRO_SYNCQUEUE_DB_TBL_COLS");SiebelApp.BrowserCacheMgr.Delete(z,A.TransactionId,B)};f.prototype.SyncRequestBuilder=function(z,C){var B;var E="~";var G="";var H=1;var A="";for(var D=0;D<C.length;D++){B="";B=C[D].Request;B=encodeURIComponent(B);G=G.concat(B,E)}if(G){G=G.slice(0,((G.length)-1));var F=G.split("~");var I=z;A=SiebelApp.AjaxRequestMgr.SetSrvrReqInputProp(I,[r.get("SYNC_PKG_LENGTH"),r.get("TOTAL_SYNC_PACKAGE_LENGTH"),r.get("SYNC_PKG_REQUESTS"),p.get("SYNC_NODE_ID"),r.get("END_OF_FILE")],[F.length,F.length,G,SiebelApp.BrowserCacheMgr.GetSyncNodeId(),H],"",x)}return A};return v}())};