/*<ORACLECOPYRIGHT>
* Copyright (C) 1994-2013 Oracle and/or its affiliates. All rights reserved.
* Oracle and Java are registered trademarks of Oracle and/or its affiliates.
* Other names may be trademarks of their respective owners.
* UNIX is a registered trademark of The Open Group.
*
* This software and related documentation are provided under a license agreement
* containing restrictions on use and disclosure and are protected by intellectual property laws.
* Except as expressly permitted in your license agreement or allowed by law, you may not use, copy,
* reproduce, translate, broadcast, modify, license, transmit, distribute, exhibit, perform, publish,
* or display any part, in any form, or by any means. Reverse engineering, disassembly,
* or decompilation of this software, unless required by law for interoperability, is prohibited.
*
* The information contained herein is subject to change without notice and is not warranted to be error-free.
* If you find any errors, please report them to us in writing.
*
* U.S. GOVERNMENT RIGHTS Programs, software, databases, and related documentation and technical data delivered to U.S.
* Government customers are "commercial computer software" or "commercial technical data" pursuant to the applicable
* Federal Acquisition Regulation and agency-specific supplemental regulations.
* As such, the use, duplication, disclosure, modification, and adaptation shall be subject to the restrictions and
* license terms set forth in the applicable Government contract, and, to the extent applicable by the terms of the
* Government contract, the additional rights set forth in FAR 52.227-19, Commercial Computer Software License
* (December 2007). Oracle America, Inc., 500 Oracle Parkway, Redwood City, CA 94065.
*
* This software or hardware is developed for general use in a variety of information management applications.
* It is not developed or intended for use in any inherently dangerous applications, including applications that
* may create a risk of personal injury. If you use this software or hardware in dangerous applications,
* then you shall be responsible to take all appropriate fail-safe, backup, redundancy,
* and other measures to ensure its safe use. Oracle Corporation and its affiliates disclaim any liability for any
* damages caused by use of this software or hardware in dangerous applications.
*
* This software or hardware and documentation may provide access to or information on content,
* products, and services from third parties. Oracle Corporation and its affiliates are not responsible for and
* expressly disclaim all warranties of any kind with respect to third-party content, products, and services.
* Oracle Corporation and its affiliates will not be responsible for any loss, costs,
* or damages incurred due to your access to or use of third-party content, products, or services.
</ORACLECOPYRIGHT>*/
if(typeof(SiebelApp.ProactiveCacheBuilder)==="undefined"){SiebelJS.Namespace("SiebelApp.ProactiveCacheBuilder");SiebelApp.ProactiveCacheBuilder=(function(){var x=new l();var B=SiebelApp.OfflineCacheConfig;var u=SiebelApp.Offlineconstants;var m=SiebelApp.OfflineAppSettings;var A=SiebelJS.Dependency("SiebelApp.Utils");var t=SiebelApp.Constants;var h=t.get("SWE_ROW_ID_FIELD");var g=u.get("METADATATABLEINFO");var q=u.get("TABLEINFO");var y=u.get("VIEW_NAME");var j=u.get("FLD_PICK_APLT_DET");var c=u.get("PICK_APLT_DET");var s=u.get("FLD_PICK_MAP");var w=u.get("PICK_MAP_INFO");var C=u.get("VIEW_INFO");var D=u.get("GOTOVIEW");var z=u.get("GETVIEWLAYOUT");var o=u.get("TEXT");var f=u.get("DEFAULT_VIEW_INFO");var n=u.get("GETCACHEDFRAME");var p=u.get("GOTOPOSTEDACTION");var i=SiebelApp.BrowserCacheMgr;var b={};var r=[];var a=window.localStorage;if(window.localStorage.getItem(q)){b=JSON.parse(a.getItem(q))}if(a.getItem(g)){r=JSON.parse(a.getItem(g))}function l(){var E;F=function F(){return E};F.prototype=this;E=new F();E.constructor=F;return E}l.prototype.ParseAndCacheData=function(I,H){var L=0;var E=I.GetChildCount();var F=m.GetSchemaStatus();var K=I.GetChildByType("SiebData");if(K){SiebelJS.Log("Caching Data...."+SiebelApp.OfflineUtils.GetTS());$(".progressbar").find("img").removeClass().addClass("cachingData");SiebelApp.S_App.uiStatus.Busy({mask:true,timeOut:false});var J=K.GetProperty("ts");if(!J){J=""}var G=K.GetProperty("fSync");if(A.IsTrue(G)){this.ClearDataTables(false)}$.callback(this,function(){if(!E){if(J){a.setItem("TS",J)}k.call(this);return}var N=I.GetChildByType("MetaData");var M=function(){a.setItem("TS",J);k.call(this)};var O=function(){SiebelApp.Metadata.Load(true);$.callback(this,function(){d.call(this,K,M,H,true,F,false)})};if(N){d.call(this,N,O,H,false,F,true)}else{O()}})}else{SiebelJS.Log("Error in downloading data package. Package doesnot have the correct PS");$(".progressbar").remove();SiebelApp.S_App.CustomToolbar.Update("FullDownLoadFailed")}};function d(K,M,F,E,N,I){var J=K.GetChildCount();var G=false;var H=0;var L=function(){var ad=K.GetChild(H);var af=ad.GetType();var aa=af;var au={};var X=[];var S;var Z=ad.GetChildCount();for(var an=0;an<Z;an++){var W=ad.GetChild(an);au[W.GetType()]=W}af=SiebelApp.OfflineUtils.RemoveNonAlphaChars(af);if(au.Schema!==undefined&&N!==2){var al;if(r.indexOf(af)!==-1){al=SiebelApp.SqlBuilder.DeleteTable(af);i.DeleteTable(al)}var ag=au.Schema.GetProperty("Schema");if(ag!==undefined){if(ag.indexOf("||")!==-1){SiebelJS.Log("Bad Schema for "+af+" :"+ag);ag=ag.replace(/||/g,"|")}G=true;X=ag.split("|");S=X.length;for(var ae=0;ae<S;ae++){X[ae]=SiebelApp.OfflineUtils.RemoveNonAlphaChars(X[ae])}if(F){X.splice(F,(S-F))}var at;var ai;var av=au.Schema.GetProperty("UKCR");if(av==="0"&&E){ai=SiebelApp.Metadata.GetBCUnqKeys(aa)}at=SiebelApp.SqlBuilder.CreateTable(af,X,ai,E);i.CreateTable(at,af,X);b[af]=X.join("`").toUpperCase().split("`");if(I){r.push(af)}SiebelApp.OfflineUtils.Log("Creating Table...")}}if(au.Data!==undefined){if(au.Data.GetChildCount()){if(b[af]){S=b[af].length;X=b[af]}var ay=au.Data.GetChildCount();var ax=ay;var ac=[];var Y=[];var R=[];G=true;SiebelApp.OfflineUtils.Log("Table: "+af+", Columns: "+X.length+", Num of Records: "+ay);for(var ar=0;ar<ax;ar++){var P=au.Data.GetChild(ar);if(!P){continue}var aj=P.GetProperty("Record");if(!aj){continue}aj=aj.replace(/\\0/g,"|").replace(/\\1/g,"^").replace(/\\2/g,"~").replace(/\\4/g,"&").replace(/\\3/g,"\\");var U=(af==="MBCs")?aj.split("^"):aj.split("|");var am=U.length;if(F){U.splice(F,(am-F))}for(var ap=0;ap<am;ap++){if(U[ap]===undefined||U[ap]===""){U[ap]=""}}if(am!==S){SiebelApp.OfflineUtils.Log("There is a mismatch in the number of columns ("+S+") and values ("+am+") for BC: "+af);if(am<S){var ah=S-am;for(ap=0;ap<ah;ap++){U.push("")}}}if(P.GetValue()==="U"){Y.push(U)}else{if(P.GetValue()==="I"){R.push(U)}else{ac.push(U)}}}if(ac.length){i.InsertRecordSet(af,X,ac)}var ao=R.length;var aq=Y.length;var T=X.length;if(ao||aq){var ab=0;for(var aw=0;aw<T;aw++){if(X[aw]==="ID"){ab=aw;break}}var ak=0;var V=function(az){if(!az.err&&(az.retVal<=0)){i.InsertRecord(af,X,Y[ak])}};var O=function(aB){ak=aB;var aC=Y[ak];var aA=(aC)[ab];var az=SiebelApp.SqlBuilder.UpdateRecord(af,X,aC,h,aA);return[az,aA]};if(aq){var Q={iterations:aq,execute:i.UpdateRecord,executeScope:i,postExecute:V,preExecute:O};$.eachAsyncOp(this,Q)}$.callback(this,function(aB){if(!aB.err){if(ao){var aA=v.call(this,R,ab);var az=SiebelApp.SqlBuilder.SelectRecord(af,aA,["ID"]);i.Execute(az.selectQuery,az.valList,true);$.callback(this,function(aE){if(!aE.err){var aI=aE.retVal;var aK=aI.length;var aG=[];var aC=[];if(aK){var aJ;for(var aD=0;aD<ao;aD++){var aF=aA[aD].Val;aJ=false;for(var aH=0;aH<aK;aH++){if(aF===aI[aH].Id){aJ=true;aG.push(R[aD]);break}}if(!aJ){aC.push(R[aD])}}}else{aC=R}i.InsertRecordSet(af,X,aC);$.callback(this,function(aN){var aL=aG.length;if(aL){var aM=0;var aP=function(aR){aM=aR;var aS=aG[aM];var aQ=aS[ab];var aT=SiebelApp.SqlBuilder.UpdateRecord(af,X,aS,h,aQ);return[aT,aQ]};if(aL){var aO={iterations:aL,execute:i.UpdateRecord,executeScope:i,postExecute:null,preExecute:aP};$.eachAsyncOp(this,aO)}}})}})}}})}}}$.callback(this,function(){if(au.drid!==undefined){var az;var aA=au.drid.GetProperty("Record");if(aA){if(aA.indexOf("|")!==-1){aA=aA.replace(/\|/g,"','")}aA="'"+aA+"'";G=true;az=SiebelApp.SqlBuilder.DeleteMutlipleRecord(af,h,aA);i.Execute(az)}}$.callback(this,function(){H++;if(H<J){L.call(this)}})})};if(H<J){L.call(this)}$.callback(this,function(){if(G){i.GetBrowserStorage().SetPostTxnCallback(M)}else{M.call(this)}})}function v(J,I){var G=[];var H;var E=J.length;for(var F=0;F<E;F++){H={};H.FieldName="ID";if(F!==0){H.PreLogic="OR"}H.Val=J[F][I];G.push(H)}return G}function k(){$(".progressbar").find("img").removeClass().addClass("offlinePackageEnd");SiebelApp.S_App.uiStatus.Free();setTimeout(function(){$(".progressbar").remove();a.setItem(q,JSON.stringify(b));a.setItem(g,JSON.stringify(r));SiebelJS.Log("Caching Data...is Done. "+SiebelApp.OfflineUtils.GetTS());SiebelApp.S_App.CustomToolbar.Update();if(m.GetMode()===true){var E=JSON.parse(a.getItem("StringCache"));if(E){SiebelApp.S_App.SetStringCache(E)}}var F=this;m.OnSuccessfulDataDownload();if(a.getItem("appCacheDone")&&JSON.parse(a.getItem("appCacheDone"))){m.ReloadToOffline()}},1000)}l.prototype.ParseAndCacheMetadata=function(K){SiebelApp.OfflineUtils.Log("Parsing and Caching Metadata...."+SiebelApp.OfflineUtils.GetTS());var L=K.GetChildCount();var R=m.GetSchemaStatus();var P;var H;var F;var G;var S=[];var E=B.get("PRO_METADATASTORE_DB_TBL_COLS");if(R===1){var O=SiebelApp.OfflineUtils.GetOfflineCacheConfig(B.get("PRO_METADATASTORE_DB"));var Q=O.tables;var N=Q.length;var M;var J=function(T){if(Q[T]==="Metadata"){var U="Type";var V="!=";M=SiebelApp.SqlBuilder.DeleteRecords(Q[T],[U],null,V);return[M,[f]]}else{M=SiebelApp.SqlBuilder.DeleteRecords(Q[T]);return[M]}};var I={execute:i.Execute,executeScope:i,preExecute:J,iterations:N};$.eachAsyncOp(this,I);$.callback(this,function(){this.ClearDataTables(true)
})}$.callback(this,function(){var Y=K.GetProperty("sc");i.CacheSCMap(Y);for(var X=0;X<L;X++){var ab=[];P=K.GetChild(X);H=P.GetType();G=P.GetProperty(y);switch(H){case j:F=P.GetProperty(c);e.call(this,H,F);continue;case s:F=P.GetProperty(w);e.call(this,H,F);continue;case C:if(G!==undefined){S.push(G)}break}var W=Object.keys(P.propArray);var aa=W.length;for(var T=0;T<aa;T++){if(W[T]!==y){ab.push(W[T])}}var Z=ab.length;for(var V=0;V<Z;V++){var U=P.propArray[ab[V]];if(U){i.InsertRecord(B.get("PRO_METADATASTORE_DB_TBL"),[E.ObjName,E.SweCmd,E.Response,E.Type],[G,ab[V],U,H])}}}i.CacheViewList(S);m.OnSuccessfulMetaDataDownload()})};l.prototype.ClearDataTables=function(E){var I=JSON.parse(a.getItem(u.get("TABLEINFO")));var J=[];var F;var L={};var H=0;for(var G in I){if(I[G]&&(r.indexOf(G)===-1)){F=G;if(F){if(E){J[H]=SiebelApp.SqlBuilder.DeleteTable(F)}else{J[H]=SiebelApp.SqlBuilder.DeleteRecords(F)}H++}}}var K=function(N){var M=J[N];return[M]};L={execute:i.Execute,executeScope:i,preExecute:K,iterations:H};$.eachAsyncOp(this,L)};function e(L,I){var M;var H;if(A.IsEmpty(I)||A.IsEmpty(L)){SiebelJS.Log("ProactiveCacheBuilder.CachePickAppletInfo: Pick Applet Details is empty.");return}switch(L){case j:M=B.get("PRO_DB_PICKAPPLET_INFO_TBL_COLS");H=I.split("|");if(H&&H.length===3){i.InsertRecord(B.get("PRO_DB_PICKAPPLET_INFO_TBL"),[M.FldInfo,M.PickApplet],[H[0]+"|"+H[1],H[2]])}else{SiebelJS.Log("ProactiveCacheBuilder.CachePickAppletInfo: "+I+" Could not cache Pick Applet Info.")}break;case s:M=B.get("PRO_DB_PICKFLD_MAP_TBL_COLS");H=I.split("|");if(H&&H.length===3){var P="null";var O=H[2];var G=O.split(",");var J=G.length;O="";for(var F=0;F<J;F++){if(!G[F]){continue}var K=G[F].split(":");var N=K.length;if(N>=2){if(K[0]&&K[1]){var E=K[0]+":"+K[1];O+=E+",";if(N===3&&K[2]==="1"){P=E}}}else{SiebelJS.Log("ProactiveCacheBuilder.ParseAndCachePickAppletInfo: Invalid pick map "+G[F])}}O=SiebelApp.OfflineUtils.RTrim(O,",");i.InsertRecord(B.get("PRO_DB_PICKFLD_MAP_TBL"),[M.BCName,M.FldName,M.PMap,M.PConstraint],[H[0],H[1],O,P])}else{SiebelJS.Log("ProactiveCacheBuilder.CachePickAppletInfo: "+I+" Could not cache Field Pick Map Info.")}break}}l.prototype.ProcessGoOnline=function(){SiebelApp.S_App.uiStatus.Busy({mask:true,timeOut:false});m.SetMode((!m.GetMode()));m.SetSyncStatus(false);SiebelApp.S_App.CustomToolbar.Update();if(SiebelApp.S_App.GetTimer()){var E=SiebelApp.S_App.GetTimer().GetLogBuffer();a.setItem(t.get("SWE_PERF_LOG_DATA"),JSON.stringify(E))}m.ReloadApp()};return x}())};